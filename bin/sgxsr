#!/bin/sh

baseLP=$dotf/guix # base-load-path

beep_once() {
    (speaker-test --test sine --frequency 440 > /dev/null 2>&1) &
    local pid=$!
    sleep 0.22
    kill -9 "$pid" 2>/dev/null
    wait "$pid" 2>/dev/null || true  # Prevent exit on wait failure
}

# Acoustic and visual notification
notify() {
    if [ "${XDG_CURRENT_DESKTOP}" = "XFCE" ]; then
        notify-send "$@"
    fi

    # command is a shell utility. `command --query` works only in fish-shell
    # speaker-test is in the alsa-utils package
    if [ "$(command -v speaker-test)" ]; then
        for i in $(seq 1 3); do beep_once; done
    else
        # if [ "$(command -v canberra-gtk-play)" ]; then
        #     for i in $(seq 1 3); do canberra-gtk-play -i message; done
        # fi
        # echo "speaker-test not found"
        : # for the sake of simplicity just give up ¯\_(ツ)_/¯
    fi
}

# GUILE_LOAD_PATH, GUILE_LOAD_COMPILED_PATH have the same values in both
# invocations
# code='(pk %load-path)'
# guile -c "${code}"
# echo ${code} | guix repl --type=machine

# code='(use-modules (gnu packages) (guix packages)) (format #t "~a\n" (package-version (car (find-packages-by-name "linux-libre"))))'
# guile -c "${code}"
# echo ${code} | guix repl --type=machine

# Exit immediately if a command exits with a non-zero status, ie. no need to
# chain the commands using '&&', since 'set -e' is used.
set -e

set -x # Print commands and their arguments as they are executed.
## Run this file by (the `~' doesn't work as a value of --load-path):
# --fallback         fall back to building when the substituter fails
# -L --load-path
# -v, --verbosity=LEVEL  use the given verbosity LEVEL

# guix repl \
#      -L $baseLP/common \
#      $baseLP/systems/common/kernel-version.scm

# TODO implement parameter: -n --no-guix-pull which skips the `guix pull ...` command
# TODO implement auto-update of linux-version in the bootloader of syst-ecke and syst-edge

# TODO add 'Do you agree with the following downgrades? [y/N]'
guix pull --cores=$cores --allow-downgrades \
     --load-path=$baseLP/common \
     --channels=$baseLP/systems/common/syst-channels.scm \
     "$@"
{ retval="$?"; set +x; } 2>/dev/null

notify "Done" "\`guix pull\` finished"

set -x # Print commands and their arguments as they are executed.

#     --allow-downgrades \

sudo guix system --cores=$cores --verbosity=3 --fallback \
     --load-path=$baseLP/common \
     --load-path=$baseLP/systems/common \
     reconfigure $baseLP/systems/syst-$(hostname).scm

# The channels for the system and home configurations may differ. Roll back the
# `guix pull` above, to effectivelly reactivate the home-channels. This won't
# behave correctly if `guix pull ... system-channels` was consecutivelly called
# more than once, but it's faster that pulling the home-channels.
#
# Need to include --allow-downgrades, since the system-channels may be newer.
#   guix pull --cores=$cores --allow-downgrades \
#        --load-path=$baseLP/common \
#        --channels=$baseLP/systems/common/home-channels.scm \
#        "$@"
guix pull --cores=$cores --roll-back "$@"

{ retval="$?"; set +x; } 2>/dev/null

exit $retval

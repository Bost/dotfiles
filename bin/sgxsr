#!/bin/sh

baseLP=$dotf/guix # base-load-path
hostname=$(hostname)

# GUILE_LOAD_PATH, GUILE_LOAD_COMPILED_PATH have the same values in both
# invocations
# code='(pk %load-path)'
# guile -c "${code}"
# echo ${code} | guix repl --type=machine

# code='(use-modules (gnu packages) (guix packages)) (format #t "~a\n" (package-version (car (find-packages-by-name "linux-libre"))))'
# guile -c "${code}"
# echo ${code} | guix repl --type=machine

set -e # Exit immediately if a command exits with a non-zero status.

## Run this file by (the `~' doesn't work as a value of --load-path):
# --fallback         fall back to building when the substituter fails
# -L --load-path
# -v, --verbosity=LEVEL  use the given verbosity LEVEL
set -x  # Print commands and their arguments as they are executed.

guix repl \
     -L $baseLP/common \
     $baseLP/systems/common/kernel-version.scm

sudo guix system --verbosity=3 --fallback \
     -L $baseLP/common \
     reconfigure $baseLP/systems/syst-$hostname.scm

{ retval="$?"; set +x; } 2>/dev/null

if [ $hostname == "ecke" ]; then
    # output two new lines
    echo "

set UUID a8fb1680-eef5-49a0-98a3-8169c9b8eeda
set device (blkid --uuid \$UUID)
if test ! (findmnt -nr -o target -S \$device)
   udisksctl mount --block-device=\$device
# else
#    printf \"%s is mounted already\n\" \$device
end
# sudo cp /media/\$USER/\$UUID/boot/grub/grub.cfg /tmp/
sudo cp /media/\$USER/ubuntu-filesyst/boot/grub/grub.cfg /tmp/
sudo chown \$USER /tmp/grub.cfg && sudo chmod +rw /tmp/grub.cfg
## Match the version number and place it to clipboard:
##  Also: grep -oP \"(\d{1,}\.)+\d{1,}\"
## Parameter abbreviations:
#   rg:   -N --no-line-number; -A --after-context; -m --max-count
#   xsel: -b --clipboard; -i --input
rg -N -A 4 -m 1 \"GNU with Linux-Libre\" /boot/grub/grub.cfg | xsel -bi
s /tmp/grub.cfg                    # edit the file
## <paste the block>
## Extract the time and generation number:
set n2 \"\d{2,}\"
set tstp (date +\"%Y-%m-%d\")
set replacement (printf '(#\$1 %s \$2)' \$tstp)
set regex (printf \".*? (\d{1,}).*(%s:%s):%s.*current\" \$n2 \$n2)
guix system describe | rg \$regex -o -r \$replacement | xsel -bi
## <paste the block>
# sudo cp /tmp/grub.cfg /media/\$USER/boot/grub/grub.cfg
sudo cp -i /tmp/grub.cfg /media/\$USER/ubuntu-filesyst/boot/grub/
sudo reboot # press <f12> during the reboot and fix the boot order
"

fi

exit $retval

#!/bin/bash -e

# values used by other sripts and applications
uname=`uname -a`
strLinux="Linux"
strLinuxMartin="Linux bost-martin"
strLinuxMartin="Linux bambi-small"
#echo uname: $uname
# the system variable strMinGw32_155 is not visible under WinGit
strMinGw32_155="MINGW32_NT-6.1 LE-C-155"

export isMinGw32_dev1=`expr match "$uname" "$strMinGw32_dev1"`
export isCygwin_dev1=`expr match "$uname" "$strCygwin_dev1"`
export isCygwin_347=`expr match "$uname" "$strCygwin_347"`
export isLinux=`expr match "$uname" "$strLinux"`
# TODO clean definition of isLinux_64
export isLinux_64=0
export isLinuxMartin=`expr match "$uname" "$strLinuxMartin"`
export isLinuxBambi=`expr match "$uname" "$strLinuxMartin"`
export isMinGw32_347=`expr match "$uname" "$strMinGw32_347"`
export isMinGw32_app1=`expr match "$uname" "$strMinGw32_app1"`
export isCygwin_155=`expr match "$uname" "$strCygwin_155"`
export isMinGw32_155=`expr match "$uname" "$strMinGw32_155"`

#echo isMinGw32_dev1: $isMinGw32_dev1
#echo isCygwin_dev1: $isCygwin_dev1
#echo isCygwin_347: $isCygwin_347
#echo isLinux: $isLinux
#echo isLinux_64: $isLinux_64
#echo isLinuxMartin: $isLinuxMartin
#echo isMinGw32_347: $isMinGw32_347
#echo isMinGw32_app1: $isMinGw32_app1
#echo isCygwin_155: $isCygwin_155
#echo isMinGw32_155: $isMinGw32_155

if [ "$isCygwin_dev1" -gt 0 ]; then
    echo "### isCygwin_dev1: $isCygwin_dev1 => Loading $strCygwin_dev1 aliases"
    base=/cygdrive
    dev=$base/d/users/$USERNAME/dev
    winapp=$base/d/users/$USERNAME/winapp

elif [ "$isCygwin_155" -gt 0 ]; then
    echo "### isCygwin_155: $isCygwin_155 => Loading $strCygwin_155"
    base=/cygdrive
    dev=$base/c/cygwin/home/$USERNAME/dev
    winapp=$base/c/winapp
    winappX86=$base/c/winapp-x86

    # export DISPLAY=":0" is needed for gvim in Cygwin Terminal
    export DISPLAY=":0"

elif [ "$isMinGw32_155" -gt 0 ]; then
    echo "### isMinGw32_155: $isMinGw32_155 => Loading $strMinGw32_155"
    dev=$base/c/cygwin/home/$USERNAME/dev
    winapp=$base/c/winapp

elif [ "$isCygwin_347" -gt 0 ]; then
    echo "### isCygwin_347: $isCygwin_347 => Loading $strCygwin_347 aliases"
    base=/cygdrive
    dev=$base/d/dev
    winapp=$base/d/winapp

elif [ "$isMinGw32_dev1" -gt 0 ]; then
    echo "### isMinGw32_dev1: $isMinGw32_dev1 => Loading $strMinGw32_dev1 aliases"
    dev=$base/d/users/$USERNAME/dev
    winapp=$base/d/users/$USERNAME/winapp

elif [ "$isMinGw32_app1" -gt 0 ]; then
    echo "### isMinGw32_app1: $isMinGw32_app1 => Loading $strMinGw32_app1 aliases"
    dev=$base/d/users/$USERNAME/dev
    winapp=$base/d/users/$USERNAME/winapp

elif [ "$isMinGw32_347" -gt 0 ]; then
    echo "### isMinGw32_347: $isMinGw32_347 => Loading $strMinGw32_347 aliases"
    dev=$base/d/dev
    winapp=$base/d/winapp

elif [ "$isLinux" -gt 0 ]; then

    x86_64="x86_64"
    uname_processor=`uname -p`
    export isLinux_64=`expr match "$uname_processor" "$x86_64"`
    #echo "### Display no message in the console if doing scp"
    #if [ "$isLinux_64" -gt 0 ]; then
        #echo "### isLinux: $isLinux_64 => Loading aliases for $strLinux $x86_64"
    #elif [ "$isLinuxMartin" -gt 0 ]; then
        #echo "### isLinux: $isLinuxMartin => Loading aliases for $strLinuxMartin"
    #else
        #echo "### isLinux: $isLinux => Loading aliases for $strLinux"
    #fi

    dev=$HOME/dev

    JAVA_CP_SEP=":"

    NAILGUN_CLI_HOME=$dev/vimclojure-nailgun-client
    VIMCLOJURE_SERVER_JAR=$dev/vimclojure-server/server-2.3.6.jar
    NAILGUN_CLIENT_HOME=$dev/vimclojure-nailgun-client
    APPENG_PYTHON_HOME=$HOME/gae/appeng-python-1.8

    if [ "$isLinux_64" -gt 0 ] || [ "$isLinuxMartin" -eq 0 ]; then
        PATH=$PATH:$HOME/bin:$APPENG_PYTHON_HOME:$NAILGUN_CLIENT_HOME
    else
        # TODO it seems like MAVEN_HOME is not needed
        #MAVEN_HOME=$HOME/apache-maven-3.0.4
        AAPPENG_HOME=$APPENG_JAVA_HOME
        APPENG_JAVA_HOME=$HOME/gae/appeng-java-sdk-1.7.1
        APPENG_PYTHON_HOME=$HOME/gae/appeng-python-1.7.2
        CLASSPATH=$dev/appengine-magic/appengine-magic-0.5.0.jar:$CLASSPATH
        # TODO try to use OpenJDK instead of Oracle JDK
        JDK_16_HOME=$HOME/java/jdk1.6.0_33
        JAVA_HOME=$HOME/java/jdk1.7.0_07
        # I need too have $PATH at the end because I want to override the pre-preinstalled java
        PATH=$JAVA_HOME/bin:$PATH:$HOME/bin:$APPENG_PYTHON_HOME:$NAILGUN_CLIENT_HOME
    fi

    PATH=$PATH:$dev/clojure-contrib/math.combinatorics-0.0.3.jar
    PATH=$PATH:$dev/clojure-contrib/algo.monads-0.1.4.jar
    PATH=$PATH:$dev/clojure-contrib/tools.macro-0.1.1.jar
    export VMAIL_VIM=gvim
    export VMAIL_BROWSER='google-chrome'

    # remaping the Esc key to Capslock (I don't use it that much)
    xmodmap -e 'clear Lock' -e 'keycode 0x42 = Escape'

    EDITOR=gvim # use it with <C-x>e
else
    echo "ERROR: No environment detected"
fi

if [ "$isLinux" -eq 0 ]; then
    echo "### isLinux: $isLinux => Loading non-$strLinux aliases"

    if [ -d "${winapp}" ]; then
        export winapp
    else
        echo "ERROR: Undefined variable winapp: ${winapp}"
        #exit
    fi

    export qDrive=$base/q
    export rosv=$qDrive/transfer/rosv
    export deployments_base=$rosv/mbs/deployments
    export deployments_mce=$deployments_base/mce
    export fDefvars=$deployments_base/defvars.sh
    #echo "fDefvars=$fDefvars"
    if [ -f "${fDefvars}" ]; then
        . "${fDefvars}"
        #echo "File loaded: ${fDefvars}"
    else
        echo "ERROR File not found: ${fDefvars}"
        exit
    fi

    export deployments_full=$deployments_mce/$rlsDate"_"$rlsVer
    JAVA_CP_SEP=";"

    export http_proxy=http://$PROXY
    export https_proxy=https://$PROXY
    export ftp_proxy=ftp://$PROXY

    #echo "CVSROOT="$CVSROOT"   # this is the active CVSROOT"

    echo export TERM=msys
    echo export http_proxy=$http_proxy
    echo export https_proxy=$https_proxy
    echo export ftp_proxy=$ftp_proxy
    echo export CVSROOT=$CVSROOT"        # active Jacarta CVSROOT"
    echo export CVSROOT=$CVSROOT_ALTERNATIVE"   # alternative Jacarta CVSROOT"
    echo export CVSROOT=$CVSROOT_MBS"    # CVSROOT for MBS"
    echo ''

#else
#    echo "Linux aliases already loaded"
fi

if [ "$isCygwin_155" -gt 0 ] || [ "$isMinGw32_155" -gt 0 ] ; then
    VIMCLOJURE_SERVER_JAR=$dev/vimclojure-server/server-2.3.6.jar
    NAILGUN_CLI_HOME=$dev/vimclojure-nailgun-client
    JDK_16_HOME=$winapp/Java/1.6.0_41
    JAVA_HOME=$winapp/Java/jdk1.7.0_15
    APPENG_JAVA_HOME=$winappX86/Google/appeng-java-sdk-1.7.1
    APPENG_PYTHON_HOME=$winappX86/Google/google_appengine

    APPENGINE_HOME=/cygdrive/c/winapp-x86/Google/appeng-java-sdk-1.7.1

    PATH=$PATH:$APPENG_PYTHON_HOME:$NAILGUN_CLIENT_HOME
fi

if [ "$isLinux_64" -eq 0 ]; then
    export JDK_16_HOME
fi

export dev
# JAVA_CP_SEP is needed for vimclojure
export JAVA_CP_SEP
export PATH
if [ "$isLinux" -eq 0 ]; then
    export JAVA_HOME
fi

if [ "$isLinuxMartin" -eq 0 ]; then
    export APPENGINE_HOME
fi

if [ "$isLinux" -gt 0 ] || [ "$isCygwin_155" -gt 0 ] || [ "$isMinGw32_155" -gt 0 ] ; then
    clojureJarFile=$dev/clojure/clojure-1.5.1.jar
    export clojureJarFile
    export VIMCLOJURE_SERVER_JAR
    export NAILGUN_CLI_HOME
    export APPENG_PYTHON_HOME
    if [ "$isLinuxMartin" -eq 0 ]; then
        export APPENG_JAVA_HOME
    fi

    # values used by other sripts and applications
    #export CLASSPATH=$HOME/dev/appengine-magic/appengine-magic-0.5.0.jar$JAVA_CP_SEP$CLASSPATH

    if [ -z $VIMCLOJURE_SERVER_JAR ]; then
        echo "ERROR: Need to define location of VimClojure nailgun server jar with:"
        echo "export VIMCLOJURE_SERVER_JAR=<location>"
        #exit 1
    fi

    if [ ! -f $VIMCLOJURE_SERVER_JAR ]; then
        echo "ERROR: Unable to find VimClojure nailgun server jar at '$VIMCLOJURE_SERVER_JAR'"
        #exit 1
    fi
fi

